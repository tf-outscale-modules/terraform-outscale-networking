pre-commit:
  stage: validate
  image: ubuntu:24.04
  rules:
    - exists:
        - .pre-commit-config.yaml
  cache:
    - key: pre-commit-${CI_COMMIT_REF_SLUG}
      paths:
        - .cache/pre-commit
    - key: mise-${CI_COMMIT_REF_SLUG}
      paths:
        - .cache/mise
  variables:
    PRE_COMMIT_HOME: "${CI_PROJECT_DIR}/.cache/pre-commit"
    MISE_DATA_DIR: "${CI_PROJECT_DIR}/.cache/mise"
  before_script:
    - apt-get update -qq && apt-get install -y -qq git curl ca-certificates python3 python3-pip > /dev/null 2>&1
    - curl -fsSL https://mise.run | MISE_VERSION=${MISE_VERSION} sh
    - export PATH="$HOME/.local/bin:$PATH"
    - mise install --yes
    - eval "$(mise activate bash)"
    - |
      curl -fsSL "https://github.com/google/osv-scanner/releases/download/v${OSV_SCANNER_VERSION}/osv-scanner_linux_amd64" -o /usr/local/bin/osv-scanner
      chmod +x /usr/local/bin/osv-scanner
    - |
      if ! git tag -l | grep -q .; then
        git tag v0.0.0
      fi
  script:
    - |
      if [ "${SKIP_OSV_SCAN}" != "true" ]; then
        osv-scanner --lockfile=. || true
      fi
    - pre-commit run -a -v
